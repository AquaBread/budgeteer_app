{% extends 'layout.html' %}
{% block content %}
<h3>Transactions</h3>
<form method="post">
    <div class="grid">
        <label>Date <input type="date" name="date" required></label>
        <label>Account
            <select name="account_id">
                {% for a in accts %}<option value="{{ a['id'] }}">{{ a['name']
                    }}</option>{% endfor %}
            </select>
        </label>
        <label>Direction
            <select name="direction">
                <option value="out">Expense (−)</option>
                <option value="in">Refund/Income (+)</option>
            </select>
        </label>
        <label>Amount (USD) <input type="number" step="0.01" name="amount"
                required></label>
        <label>Category
            <select name="category_id" required>
                <option value disabled selected>— Select a category —</option>
                {% for group_name, items in cats|groupby('group_name') %}
                {% if group_name %}
                <optgroup label="{{ group_name }}">
                    {% endif %}
                    {% for c in items %}
                    <option value="{{ c['id'] }}">{{ c['name'] }}</option>
                    {% endfor %}
                    {% if group_name %}
                </optgroup>
                {% endif %}
                {% endfor %}
            </select>
        </label>
        <div class="form-field">
            <div class="field-header">
                <span class="field-label">Tags</span>
                <span class="field-hint">Click to toggle</span>
            </div>

            <div class="tag-picker" role="listbox" aria-label="Tags">
                {% for t in tags %}
                <label class="tag-pill selectable"
                        style="--tag: {{ t.color }};">
                    <input type="checkbox" name="tag_ids" value="{{ t.id }}">
                    <span class="tag-text">{{ t.name }}</span>
                </label>
                {% endfor %}
            </div>
        </div>
    </div>
    <label>Description <input name="description"
            placeholder="Store / Note"></label>
    <button>Add Transaction</button>
</form>

<table>
    <thead>
        <tr>
            <th>Date</th>
            <th>Account</th>
            <th>Description</th>
            <th>Category</th>
            <th>Tags</th>
            <th class="right">Amount</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for t in tx %}
        <tr>
            <td>{{ t['date'] }}</td>
            <td>{{ t['account'] }}</td>
            <td>{{ t['description'] or '' }}</td>
            <td>{{ t['category'] or '' }}</td>
            <td>
                {% if t['tags'] %}
                    {% for tag in t['tags'].split(',') %}
                        {% set parts = tag.split('|') %}
                        {% if parts|length == 2 %}
                            <span class="tag-pill"
                                style="border-color: {{ parts[1] }}; color: {{ parts[1] }};">
                                {{ parts[0] }}
                            </span>
                        {% else %}
                            <span class="tag-pill">{{ tag }}</span>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </td>
            <td class="right {{ 'neg' if t['amount_cents']<0 else 'pos' }}">
                ${{ '%.2f' % (t['amount_cents']/100) }}
            </td>
            <td>
                <form method="post"
                        action="{{ url_for('delete_transaction', tx_id=t['id']) }}"
                        class="delete-form"
                        data-date="{{ t['date'] }}"
                        data-desc="{{ t['description'] or '' }}"
                        data-amount="{{ '%.2f' % (t['amount_cents']/100) }}"
                        data-sign="{{ 'neg' if t['amount_cents']<0 else 'pos' }}">
                    <button type="submit" class="secondary">Delete</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<dialog id="deleteTxModal" class="modal">
    <form method="dialog" class="modal-card" id="deleteTxCard">
        <header class="modal-head">
            <h4>Delete transaction?</h4>
            <button class="icon-btn" value="cancel" aria-label="Close">✕</button>
        </header>

        <div class="modal-body">
            <p class="muted">This can’t be undone.</p>

            <div class="tx-preview">
            <div><strong id="mDate"></strong></div>
            <div id="mDesc" class="muted"></div>
            <div id="mAmount" class="amount"></div>
            </div>
        </div>

        <footer class="modal-actions">
            <button value="cancel" class="secondary">Cancel</button>
            <button id="mConfirm" class="danger" value="confirm">Delete</button>
        </footer>
    </form>
</dialog>
<script>
  const modal = document.getElementById("deleteTxModal");
  const mDate = document.getElementById("mDate");
  const mDesc = document.getElementById("mDesc");
  const mAmount = document.getElementById("mAmount");
  const mConfirm = document.getElementById("mConfirm");

  let pendingForm = null;

  document.addEventListener("submit", (e) => {
    const form = e.target.closest(".delete-form");
    if (!form) return;

    e.preventDefault();
    pendingForm = form;

    mDate.textContent = form.dataset.date || "";
    mDesc.textContent = form.dataset.desc || "(No description)";
    mAmount.textContent = "$" + (form.dataset.amount || "0.00");
    mAmount.className = "amount " + (form.dataset.sign || "");

    modal.showModal();
  });

  modal.addEventListener("close", () => {
    if (modal.returnValue === "confirm" && pendingForm) {
      pendingForm.submit();
    }
    pendingForm = null;
  });

  // close on click outside the card
  modal.addEventListener("click", (e) => {
    const card = document.getElementById("deleteTxCard");
    if (!card.contains(e.target)) modal.close("cancel");
  });
</script>

{% endblock %}
