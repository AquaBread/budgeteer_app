{% extends 'layout.html' %}
{% block content %}
<h3>Recurring Expenses</h3>

<form method="post">
    <div class="grid">
        <label>Name
            <input name="name" placeholder="Rent, Spotify, etc." required>
        </label>
        <label>Account
            <select name="account_id">
                {% for a in accts %}
                <option value="{{ a['id'] }}">{{ a['name'] }}</option>
                {% endfor %}
            </select>
        </label>
        <label>Category
            <select name="category_id" required>
                <option value disabled selected>— Select a category —</option>
                {% for group_name, items in cats|groupby('group_name') %}
                {% if group_name %}
                <optgroup label="{{ group_name }}">
                    {% endif %}
                    {% for c in items %}
                    <option value="{{ c['id'] }}">{{ c['name'] }}</option>
                    {% endfor %}
                    {% if group_name %}
                </optgroup>
                {% endif %}
                {% endfor %}
            </select>
        </label>
        <label>Amount (USD)
            <input type="number" step="0.01" name="amount" required>
        </label>
        <label>Day of Month (1–28)
            <input type="number" min="1" max="28" name="day_of_month" required>
        </label>
        <label>Direction
            <select name="direction" required>
                <option value="out" selected>Expense (−)</option>
                <option value="in">Income (+)</option>
            </select>
        </label>
        <label>
            <input type="checkbox" name="active" checked>
            Active
        </label>
    </div>
    <button type="submit">Add Recurring Expense</button>
</form>

<hr>

<table>
    <thead>
        <tr>
            <th>Name</th>
            <th>Account</th>
            <th>Category</th>
            <th>Day</th>
            <th>Amount</th>
            <th>Active</th>
            <th>Actions</th>
            <th>Direction</th>
        </tr>
    </thead>
    <tbody>
        {% for r in recs %}
        <tr>
            <td>{{ r['name'] }}</td>
            <td>{{ r['account_name'] }}</td>
            <td>{{ r['category_name'] or '' }}</td>
            <td>{{ r['day_of_month'] }}</td>
            <td>${{ '%.2f' % (r['amount_cents']/100) }}</td>
            <td>{{ 'Yes' if r['active'] else 'No' }}</td>
            <td>
                <form method="post"
                    action="{{ url_for('recurring.toggle', rec_id=r['id']) }}"
                    style="display:inline">
                    <button type="submit">
                        {% if r['active'] %}Disable{% else %}Enable{% endif %}
                    </button>
                </form>

                <form method="post"
                    action="{{ url_for('recurring.delete', rec_id=r['id']) }}"
                    style="display:inline"
                    onsubmit="return confirm('Delete this recurring expense?');">
                    <button type="submit" class="secondary">Delete</button>
                </form>
            </td>
            <td>{{ 'Income' if r['direction']=='in' else 'Expense' }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% endblock %}
